#cloud-config

package_update: true
package_upgrade: true

packages:
  - nginx
  - curl
  - wget
  - language-pack-ja-base
  - language-pack-ja

timezone: Asia/Tokyo
locale: ja_JP.UTF-8

users:
  - name: yumnumm
    groups: sudo,www-data
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    ssh_import_id: github:yumnumm

write_files:
  - path: /var/www/html/index.html
    permissions: "0644"
    owner: www-data:www-data
    content: |
      <!DOCTYPE html>
      <html lang="ja">
      <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>RX2530 Home Server - Nginx Container</title>
          <style>
              body {
                  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                  line-height: 1.6;
                  color: #333;
                  max-width: 1200px;
                  margin: 0 auto;
                  padding: 20px;
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  min-height: 100vh;
              }
              .container {
                  background: white;
                  padding: 30px;
                  border-radius: 10px;
                  box-shadow: 0 10px 30px rgba(0,0,0,0.1);
              }
              .header {
                  text-align: center;
                  margin-bottom: 30px;
                  padding-bottom: 20px;
                  border-bottom: 2px solid #667eea;
              }
              .header h1 {
                  color: #667eea;
                  margin: 0;
                  font-size: 2.5em;
              }
              .header p {
                  color: #666;
                  font-size: 1.2em;
                  margin: 10px 0 0 0;
              }
              .info-grid {
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                  gap: 20px;
                  margin-top: 30px;
              }
              .info-card {
                  background: #f8f9fa;
                  padding: 20px;
                  border-radius: 8px;
                  border-left: 4px solid #667eea;
              }
              .info-card h3 {
                  color: #333;
                  margin-top: 0;
                  margin-bottom: 15px;
              }
              .info-card ul {
                  margin: 0;
                  padding-left: 20px;
              }
              .info-card li {
                  margin-bottom: 5px;
              }
              .status {
                  background: #d4edda;
                  color: #155724;
                  padding: 15px;
                  border-radius: 8px;
                  text-align: center;
                  margin: 20px 0;
                  border: 1px solid #c3e6cb;
              }
              .footer {
                  text-align: center;
                  margin-top: 40px;
                  padding-top: 20px;
                  border-top: 1px solid #eee;
                  color: #666;
              }
          </style>
      </head>
      <body>
          <div class="container">
              <div class="header">
                  <h1>üè† RX2530 Home Server</h1>
                  <p>Infrastructure as Code - Nginx Container</p>
              </div>
              
              <div class="status">
                  ‚úÖ Nginx Container is running successfully!
              </div>
              
              <div class="info-grid">
                  <div class="info-card">
                      <h3>üñ•Ô∏è Server Information</h3>
                      <ul>
                          <li><strong>Host:</strong> RX2530 Home Server</li>
                          <li><strong>Container:</strong> nginx (LXD)</li>
                          <li><strong>OS:</strong> Ubuntu 24.04</li>
                          <li><strong>Web Server:</strong> Nginx</li>
                          <li><strong>Port:</strong> 8000</li>
                      </ul>
                  </div>
                  
                  <div class="info-card">
                      <h3>üîß Infrastructure Details</h3>
                      <ul>
                          <li><strong>Management:</strong> Terraform + LXD</li>
                          <li><strong>Provisioning:</strong> Cloud-init</li>
                          <li><strong>Remote State:</strong> Cloudflare R2</li>
                          <li><strong>CI/CD:</strong> GitHub Actions (Self-hosted)</li>
                      </ul>
                  </div>
                  
                  <div class="info-card">
                      <h3>üåê Other Services</h3>
                      <ul>
                          <li>Loki („É≠„Ç∞ÁÆ°ÁêÜ)</li>
                          <li>Docker Registry</li>
                          <li>Monitor (Grafana, Prometheus)</li>
                          <li>Media Server</li>
                          <li>Network (Tailscale, Cloudflared)</li>
                      </ul>
                  </div>
                  
                  <div class="info-card">
                      <h3>üìä Container Resources</h3>
                      <ul>
                          <li><strong>Type:</strong> LXD Container</li>
                          <li><strong>CPU:</strong> Shared</li>
                          <li><strong>Memory:</strong> Shared</li>
                          <li><strong>Network:</strong> Bridge</li>
                      </ul>
                  </div>
              </div>
              
              <div class="footer">
                  <p>Powered by RX2530 Home Server Infrastructure | Managed with Terraform & LXD</p>
                  <p>üöÄ Generated: <span id="date"></span></p>
              </div>
          </div>
          
          <script>
              document.getElementById('date').textContent = new Date().toLocaleString('ja-JP');
          </script>
      </body>
      </html>

runcmd:
  # Configure nginx
  - systemctl enable nginx
  - systemctl start nginx
  
  # Set proper permissions for web directory
  - chown -R www-data:www-data /var/www/html
  - chmod -R 755 /var/www/html
  
  # Create nginx configuration for port 8000 (internal)
  - |
    cat > /etc/nginx/sites-available/default << 'EOF'
    server {
        listen 80 default_server;
        listen [::]:80 default_server;
        
        root /var/www/html;
        index index.html index.htm index.nginx-debian.html;
        
        server_name _;
        
        location / {
            try_files $uri $uri/ =404;
        }
        
        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;
        add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
    }
    EOF
  
  # Test nginx configuration and reload
  - nginx -t
  - systemctl reload nginx

final_message: "Nginx container setup completed successfully"